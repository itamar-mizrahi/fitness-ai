<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××××Ÿ ×›×•×©×¨ ×—×›× ğŸ‹ï¸â€â™‚ï¸ğŸ”</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    
    <!-- ×¡×¤×¨×™×•×ª MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            text-align: center;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        h1, h2 { margin-bottom: 20px; }

        /* ×¢×™×¦×•×‘ ×˜×•×¤×¡ ×”×”×ª×—×‘×¨×•×ª */
        #login-screen {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            display: flex; /* ×’××™×© ×›×“×™ ×œ××¨×›×– */
            flex-direction: column;
            gap: 15px;
            margin-top: 50px;
        }
        
        input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box; /* ×›×“×™ ×©×”-padding ×œ× ×™×’×“×™×œ ××ª ×”×¨×•×—×‘ */
        }

        button {
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            width: 100%;
        }

        button:hover { background: #0056b3; }
        
        button.secondary {
            background: #6c757d;
            margin-top: 10px;
        }
        button.secondary:hover { background: #545b62; }

        button.success {
            background: #28a745;
        }
        button.success:hover { background: #218838; }

        /* ××¡×š ×”××™××•×Ÿ (××•×¡×ª×¨ ×‘×”×ª×—×œ×”) */
        #workout-screen {
            display: none;
            width: 100%;
            max-width: 800px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            aspect-ratio: 4/3; /* ×™×—×¡ ×¨×•×—×‘-×’×•×‘×” ×§×‘×•×¢ */
            margin: 20px auto;
            background: black;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        video { display: none; }
        
        canvas {
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* ××¨××” */
            display: block;
        }

        /* ×›×¨×˜×™×¡ ×”××™×“×¢ ×¢×œ ×”××¡×š */
        .counter-card {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 12px;
            color: #333;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .count-number {
            font-size: 64px;
            color: #dc3545;
            margin: 5px 0;
            line-height: 1;
        }
        
        #feedback {
            font-size: 18px;
            color: #007bff;
            margin-bottom: 10px;
        }

        #user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

    <!-- 1. ××¡×š ×”×ª×—×‘×¨×•×ª -->
    <div id="login-screen">
        <h2>ğŸ‹ï¸â€â™‚ï¸ ×”×ª×—×‘×¨×•×ª ×œ××××Ÿ ×”××™×©×™</h2>
        <input type="email" id="email" placeholder="×›×ª×•×‘×ª ××™××™×™×œ">
        <input type="password" id="password" placeholder="×¡×™×¡××”">
        <button onclick="handleLogin()">×”×ª×—×‘×¨ / ×”×¨×©×</button>
        <p id="login-msg" style="color: #dc3545; margin: 10px 0 0; font-size: 14px;"></p>
    </div>

    <!-- 2. ××¡×š ×”××™××•×Ÿ (×™×•×¤×™×¢ ×¨×§ ××—×¨×™ ×”×ª×—×‘×¨×•×ª) -->
    <div id="workout-screen">
        <div id="user-info">
            <span>×©×œ×•×, <b id="user-email"></b> ğŸ‘‹</span>
            <button onclick="handleLogout()" style="width: auto; padding: 8px 15px; font-size: 14px;" class="secondary">×™×¦×™××”</button>
        </div>

        <div class="video-container">
            <div class="counter-card">
                <div>×—×–×¨×•×ª</div>
                <div id="counter" class="count-number">0</div>
                <div id="feedback">××•×›×Ÿ?</div>
                <button onclick="saveData()" class="success" style="font-size: 14px; padding: 8px;">ğŸ’¾ ×©××•×¨</button>
            </div>
            <video id="input_video"></video>
            <canvas id="output_canvas" width="640" height="480"></canvas>
        </div>
    </div>

    <!-- ×˜×¢×™× ×ª Firebase ×•×”×œ×•×’×™×§×” ×”×¨××©×™×ª -->
    <script type="module">
        // --- ×™×™×‘×•× ×¡×¤×¨×™×•×ª Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } 
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- ×”×§×•× ×¤×™×’×•×¨×¦×™×” ×©×œ×š (×”×•×¢×ª×§×” ×‘××“×•×™×§) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDzgdcJASKzZz9azdNrmrJz3MWhlBcdvyg",
            authDomain: "fitness-auth-54d4d.firebaseapp.com",
            projectId: "fitness-auth-54d4d",
            storageBucket: "fitness-auth-54d4d.firebasestorage.app",
            messagingSenderId: "355871344430",
            appId: "1:355871344430:web:3cedacd33df478bf665cbf",
            measurementId: "G-QXP15SPSHC"
        };

        // ××ª×—×•×œ Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let currentUser = null;

        // --- ×œ×•×’×™×§×ª ×”×ª×—×‘×¨×•×ª ---
        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            
            msg.innerText = "××ª×—×‘×¨...";
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    try {
                        msg.innerText = "××©×ª××© ×—×“×©? ×™×•×¦×¨ ×—×©×‘×•×Ÿ...";
                        await createUserWithEmailAndPassword(auth, email, pass);
                    } catch (createError) {
                        msg.innerText = "×©×’×™××” ×‘×™×¦×™×¨×”: " + createError.message;
                    }
                } else {
                    msg.innerText = "×©×’×™××”: " + error.message;
                }
            }
        };

        window.handleLogout = () => {
            signOut(auth).then(() => window.location.reload());
        };

        // --- ×”××–× ×” ×œ×©×™× ×•×™×™ ××¦×‘ (×”××¢×‘×¨ ×‘×™×Ÿ ×”××¡×›×™×) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('workout-screen').style.display = 'block';
                document.getElementById('user-email').innerText = user.email;
                startCamera(); // ×”×ª×—×œ×ª ×”××¦×œ××” ×¨×§ ×›×©×™×© ××©×ª××©
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('workout-screen').style.display = 'none';
            }
        });

        // --- ×œ×•×’×™×§×ª MediaPipe ×•×¡×¤×™×¨×” ---
        let counter = 0;
        let stage = "down";

        // ×¤×•× ×§×¦×™×™×ª ×©××™×¨×” (××§×•×©×¨×ª ×œ×›×¤×ª×•×¨)
        window.saveData = async () => {
            if(!currentUser) return alert("××™× ×š ××—×•×‘×¨!");
            
            const serverUrl = "https://my-ai-app-latest.onrender.com/save_workout";
            
            try {
                const btn = document.querySelector('button.success');
                const originalText = btn.innerText;
                btn.innerText = "×©×•×œ×—...";
                
                const response = await fetch(serverUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        reps: counter,
                        user_email: currentUser.email
                    })
                });
                
                if(response.ok) {
                    alert("âœ… ×”××™××•×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”!");
                } else {
                    alert("âŒ ×©×’×™××” ×‘×©××™×¨×” ×‘×©×¨×ª");
                }
                btn.innerText = originalText;
                
            } catch (e) { 
                console.error(e);
                alert("âŒ ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª");
            }
        };

        function calculateAngle(a, b, c) {
            let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        function onResults(results) {
            const canvasElement = document.getElementById('output_canvas');
            const canvasCtx = canvasElement.getContext('2d');
            const feedback = document.getElementById('feedback');
            const counterEl = document.getElementById('counter');

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // ×¦×™×•×¨ ×ª××•× ×ª ×”××¦×œ××”
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                // ×¦×™×•×¨ ×”×©×œ×“
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                             {color: '#00FF00', lineWidth: 4});
                drawLandmarks(canvasCtx, results.poseLandmarks,
                            {color: '#FF0000', lineWidth: 2});

                // ×œ×•×’×™×§×ª ×¡×¤×™×¨×” (×™×“ ×©×××œ: 11=×›×ª×£, 13=××¨×¤×§, 15=×©×•×¨×© ×›×£ ×™×“)
                const shoulder = results.poseLandmarks[11];
                const elbow = results.poseLandmarks[13];
                const wrist = results.poseLandmarks[15];

                if (shoulder && elbow && wrist) {
                    const angle = calculateAngle(shoulder, elbow, wrist);
                    
                    if (angle > 160) {
                        stage = "down";
                        feedback.innerText = "×œ××˜×” ğŸ‘‡";
                        feedback.style.color = "white";
                    }
                    if (angle < 30 && stage === "down") {
                        stage = "up";
                        counter++;
                        counterEl.innerText = counter;
                        feedback.innerText = "××¢×•×œ×”! ğŸ‘†";
                        feedback.style.color = "#00FF00";
                    }
                    
                    // ×”×¦×’×ª ×”×–×•×•×™×ª ×œ×“×™×‘×•×’
                    canvasCtx.fillStyle = "yellow";
                    canvasCtx.font = "24px Arial";
                    canvasCtx.fillText(Math.round(angle), elbow.x * canvasElement.width, elbow.y * canvasElement.height);
                }
            }
            canvasCtx.restore();
        }

        // ×”×’×“×¨×ª MediaPipe Pose
        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        pose.onResults(onResults);

        // ×¤×•× ×§×¦×™×” ×œ×”×ª×—×œ×ª ×”××¦×œ××” (× ×§×¨××ª ×¨×§ ××—×¨×™ ×”×ª×—×‘×¨×•×ª)
        function startCamera() {
            const videoElement = document.getElementById('input_video');
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await pose.send({image: videoElement});
                },
                width: 640,
                height: 480
            });
            camera.start();
        }
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('PWA: ServiceWorker registration successful with scope: ', registration.scope);
                }).catch(err => {
                    console.error('PWA: ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>