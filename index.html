<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title> 驻驻转 专驻拽 </title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #2c3e50;
        color: white;
        font-family: sans-serif;
        margin: 0;
        padding: 20px;
      }

      .video-container {
        position: relative;
        width: 640px;
        height: 480px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        background: black;
      }

      video {
        display: none;
      }

      canvas {
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      /* 专住 注 注 住 */
      .counter-card {
        position: absolute;
        top: 10px;
        right: 10px; /*  砖驻 转 拽住,  专 爪 砖 */
        background-color: rgba(255, 255, 255, 0.8);
        padding: 15px;
        border-radius: 10px;
        color: black;
        font-size: 24px;
        font-weight: bold;
        z-index: 10;
      }

      .count-number {
        font-size: 48px;
        color: #e74c3c;
      }
    </style>
  </head>
  <body>
    <h1>  驻驻转 专驻拽</h1>

    <div class="video-container">
      <div class="counter-card">
        <div>专转:</div>
        <div id="counter" class="count-number">0</div>
        <div id="feedback" style="font-size: 18px; color: blue">转转!</div>
        <button
          onclick="saveData()"
          style="
            margin-top: 10px;
            padding: 10px;
            background: green;
            color: white;
            border: none;
            border-radius: 5px;
          "
        >
           砖专 
        </button>
      </div>
      <video id="input_video"></video>
      <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <script>
      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const countElement = document.getElementById("counter");
      const feedbackElement = document.getElementById("feedback");

      // 砖转  住驻专
      let counter = 0;
      let stage = "down"; // 爪  砖  (/注)

      // 驻拽爪 砖 转  3 拽转
      function calculateAngle(a, b, c) {
        let radians =
          Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs((radians * 180.0) / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return angle;
      }

      function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(
          results.image,
          0,
          0,
          canvasElement.width,
          canvasElement.height
        );

        if (results.poseLandmarks) {
          // 爪专 砖
          drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
            color: "#00FF00",
            lineWidth: 4,
          });
          drawLandmarks(canvasCtx, results.poseLandmarks, {
            color: "#FF0000",
            lineWidth: 2,
          });

          // --- 拽 砖 住驻专 ---
          // 拽转 驻转 (MediaPipe Indexes):
          // 11 = 转祝 砖, 13 = 专驻拽 砖, 15 = 砖专砖 祝  砖
          const shoulder = results.poseLandmarks[11];
          const elbow = results.poseLandmarks[13];
          const wrist = results.poseLandmarks[15];

          //  砖爪 专 转  
          if (shoulder && elbow && wrist) {
            // 砖 转
            const angle = calculateAngle(shoulder, elbow, wrist);

            // 拽转 爪 
            if (angle > 160) {
              stage = "down";
              feedbackElement.innerText = " ";
            }
            if (angle < 30 && stage === "down") {
              stage = "up";
              counter += 1;
              countElement.innerText = counter;
              feedbackElement.innerText = "注! ";
            }

            // 爪转 转  专驻拽 ()
            canvasCtx.fillStyle = "white";
            canvasCtx.font = "20px Arial";
            canvasCtx.fillText(
              Math.round(angle),
              elbow.x * canvasElement.width,
              elbow.y * canvasElement.height
            );
          }
        }
        canvasCtx.restore();
      }

      const pose = new Pose({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        },
      });

      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });

      pose.onResults(onResults);

      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await pose.send({ image: videoElement });
        },
        width: 640,
        height: 480,
      });
      camera.start();

      async function saveData() {
        const serverUrl = "https://my-ai-app-latest.onrender.com/save_workout"; // <--- 转转 砖 -Render

        try {
          alert("砖 转 注... 锔");

          const response = await fetch(serverUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ reps: counter }),
          });

          if (response.ok) {
            const result = await response.json();
            alert(
              `砖专 爪! \n住驻专 专转: ${result.reps}\n: ${result.timestamp}`
            );
          } else {
            alert("砖 砖专 ");
          }
        } catch (error) {
          console.error(error);
          alert(" 爪转 转专 砖专转.");
        }
      }
    </script>
  </body>
</html>
